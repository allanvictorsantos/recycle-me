// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USUÁRIOS ---
model User {
  id          Int          @id @default(autoincrement())
  name        String
  email       String       @unique
  password    String
  
  // Gamificação
  points      Int          @default(0) // Saldo atual
  xp          Int          @default(0) // Histórico total (Nível)
  level       Int          @default(1) 
  isCertified Boolean      @default(false)
  
  // Relações
  collections Collection[] // Histórico de coletas (Ganhos)
  redemptions Redemption[] // Histórico de compras (Gastos) -- NOVO

  createdAt   DateTime     @default(now())
}

// --- MERCADOS ---
model Market {
  id          Int          @id @default(autoincrement())
  name        String       
  tradeName   String?      
  password    String
  cnpj        String       @unique
  email       String       @unique 
  isVerified  Boolean      @default(false) 
  
  // Endereço
  latitude    Float?
  longitude   Float?
  address     String?
  cep         String?
  numero      String?
  
  collections Collection[]
  offers      Offer[]      // Ofertas criadas por este mercado -- NOVO

  createdAt   DateTime     @default(now())
}

// --- TRANSAÇÕES DE RECICLAGEM (Ganha Pontos) ---
model Collection {
  id           Int              @id @default(autoincrement())
  materialType String           
  weightInKg   Float?           
  status       CollectionStatus @default(PENDING)
  pointsEarned Int              @default(0)
  
  userId       Int
  user         User             @relation(fields: [userId], references: [id])
  
  marketId     Int?             
  market       Market?          @relation(fields: [marketId], references: [id])

  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

// --- OFERTAS (Produtos/Cupons) -- NOVO ---
model Offer {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  cost        Int
  image       String?  // Ícone
  active      Boolean  @default(true)

  // --- NOVOS CAMPOS: VALIDADE ---
  validFrom   DateTime? // Opcional (se for nulo, vale pra sempre)
  validUntil  DateTime? // Opcional

  marketId    Int
  market      Market   @relation(fields: [marketId], references: [id])

  redemptions Redemption[]
  createdAt   DateTime @default(now())
}
// --- RESGATES (Transação de Compra) -- NOVO ---
model Redemption {
  id        Int      @id @default(autoincrement())
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  offerId   Int
  offer     Offer    @relation(fields: [offerId], references: [id])
  
  costAtTime Int     // Quanto custou na hora (caso o preço mude depois)
  couponCode String  // O código para mostrar no caixa (Ex: #X99-2024)
  
  createdAt DateTime @default(now())
}

enum CollectionStatus {
  PENDING
  COMPLETED
  REJECTED
}